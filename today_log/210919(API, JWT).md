# 210919(API, JWT)

## 오늘 뭐했지?

- 팀원분들과 함께 협업 프로젝트에 [README.md](https://github.com/jongwanra/muscle-course/blob/main/README.md) 파일 업로드
- 내일부터 진행 될 노드js 계획세우기
- 집 대청소...
- 자전거 타기, 턱걸이 하기
- 어제 수정했던 프로젝트 재배포!!

오늘은 간만에 푹잤다 ㅎㅎ 푹 잤다고 해봤자 6시간 정도 ...!! 자고 일어나서 청소하고 1시 쯤 되서 게더타운에 들어왔다. 끝난 5일간의 프로젝트가 사실 나는 아직 까지도 찝찝하고 부족한 기능들이 많다고 생각해서 오늘은 댓글 기능을 더 만져 보기도 하고 처음 작성했던 API 설계서를 다시 만져보기도 했다. 내일부터는 새롭게 Node.js에 몰입해야지 하는 각오와 계획을 세웠다. 그리고 원래 초반의 계획은 아무리 피곤해더라도 알고리즘 문제는 3문제씩 풀자였는데.. 역시 프로젝트에만 몰입을 하면 정말 시간 가는 줄 모르고 하고 있는 내 모습을 보면서 3문제 보다는 1문제씩만, 1일 1문제는 꼭 풀자고 스스로 타협을 했다.ㅋㅋㅋ Today's log를 끝내면 꼭!! 한 문제 풀고 내일을 준비해야지

## API란?

나는 API를 메뉴판이라고 생각한다. 내가 피자집 가게를 갔다. 피자집 가게에 존재하는 메뉴판이 바로 **API**이다.

페퍼로니피자, 포테이토피자 등등이 적혀있고 메뉴판에 적혀있는 것을 종업원에게 주문을 하면 종업원은 주방장에게 해당 피자를 만들어달라고 할 것이다. 그리고 다 만들어진 피자를 내가 받게 된다.

API란  Application Programming Interface의 약자로 두 대상이 데이터를 주고 받기 위한 방법이다.

위에서 설명한 고객이 클라이언트이고 내 주문을 받은 주방장이 서버이다. 그리고 내가 본 메뉴판이 바로 API이다.

그렇다면 종업원은? 

내가 생각하는 종업원은 바로 브라우저이다. 내가 클릭을 하거나 url창에 친 정보를 서버에 보내주는 역할을 하기 때문이다. 

그럼 피자집에 가서 내가 김치가 있는지 종업원에게 물어본다면? 메뉴판에는 당연히 김치는 없을 것이다. 그런데 혹여나 있을까 해서 종업원은 주방장에게 가서 물어볼 것이다 김치가 있는지 그렇다면 대부분 김치가 없다고 요청에 대한 응답을 해주면 종업원은 나에게 김치가 없다고 말해줄 것이다.

결국 웹개발에서 API란, 클라이언트가 요청을 했을 때, 그것에 대해서 어떻게 처리할지가 적혀져 있는 명세서이다.

## JWT란?

먼저 코드를 읽어보자 .

```python
@api_login.route('/sign_in', methods=['POST'])
def sign_in():
    # 로그인(클라이언트로 부터 들어온 id, password를 받는다.)
    username_receive = request.form['username_give'] 
    password_receive = request.form['password_give']

    # password를 다른 누가 봐도 알아볼 수 없게끔 hashFunction을 사용해서 암호화 한다.
    pw_hash = hashlib.sha256(password_receive.encode('utf-8')).hexdigest()
    # DB에 저장된 암호화된 Password와 정보가 일치한 유저를 찾는다.
    result = db.users.find_one({'username': username_receive, 'password': pw_hash})
    
    # ID와 Password가 일치한 클라이언트일 경우
    if result:
        # payload: 토큰에 담을 정보
        # payload에 고객의 이름과 로그인이 가능한 시간을 담는다.
        payload = {
            'id': username_receive,
            'exp': datetime.utcnow() + timedelta(seconds=60 * 60 * 24)  # 로그인 24시간 유지
        }
        # 배포할 때! 
        # jwt.encode()를 통해 암호화를 진행하여 토큰을 발급하고 반환한다.
        token = jwt.encode(payload, SECRET_KEY, algorithm='HS256').decode('utf-8') # 이 부분!!!! 유심히 확인
        # token = jwt.encode(payload, SECRET_KEY, algorithm='HS256')
        return jsonify({'result': 'success', 'token': token})
    # 일치하지 않을 경우,
    else:
        return jsonify({'result': 'fail', 'msg': '아이디/비밀번호가 일치하지 않습니다.'})
```

로그인 창에서 클라이언트로 부터 들어온 요청을 ID와 Password를 통해 확인하고 해당하는 정보가 DB에 있다면 토큰과 함께 결과를 반환하고, 일치하지 않을 경우는 fail을 반환하는 API이다.

JWT는 Json Web Token의 약자로, 전자 서명이 된 URL-safe의 Json이며, 토큰 기반 인증 방식이다.

사용자가 로그인에 성공을 하면,  signed token을 발급해 준다. 클라이언트 측에서 서버로 부터 전달받은 토큰을 저장하고, 서버에 요청할 때마다 해당 토큰을 함께 서버에 전달한다. 이 방법을 통해 해당 유저에 대해서 로그인이 되어있음을 알고 유저에 맞는 정보를 보여 줄 수 있다.
